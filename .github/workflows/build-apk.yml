name: build-apk

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # Use repo workspace subfolders (safe & cacheable)
      GRADLE_USER_HOME: ${{ github.workspace }}/.cache/gradle
      PUB_CACHE: ${{ github.workspace }}/.cache/pub
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      # Increase Gradle/JVM memory to avoid OOM/jlink crashes
      ORG_GRADLE_JVMARGS: -Xmx4g -Dkotlin.daemon.jvm.options="-Xmx2g" -Dfile.encoding=UTF-8
      _JAVA_OPTIONS: -Xmx4g

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache Flutter pub & Gradle
        uses: actions/cache@v4
        with:
          path: |
            .cache/pub
            .cache/gradle
          key: ${{ runner.os }}-flutter-deps-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-deps-

      - name: Setup Java 17 (avoid jlink quirks from Java 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter (pinned)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.24.3
          cache: true

      - name: Ensure Android SDK tools are installed
        run: |
          sudo mkdir -p /usr/local/lib/android
          sudo chown -R $USER:$USER /usr/local/lib/android
          # Accept licenses and install minimal required packages
          yes | sdkmanager --sdk_root=${ANDROID_SDK_ROOT} --licenses || true
          sdkmanager --sdk_root=${ANDROID_SDK_ROOT} "platform-tools" "platforms;android-34" "build-tools;34.0.0" "cmdline-tools;latest"

      - name: Show environment & versions (debug)
        run: |
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"
          flutter --version
          java -version
          echo "GRADLE_USER_HOME=$GRADLE_USER_HOME"

      - name: Flutter pub get
        env:
          PUB_CACHE: ${{ github.workspace }}/.cache/pub
        run: flutter pub get

      - name: Build debug APK (no shrink for reliability)
        env:
          GRADLE_USER_HOME: ${{ github.workspace }}/.cache/gradle
          PUB_CACHE: ${{ github.workspace }}/.cache/pub
        run: |
          flutter clean || true
          flutter build apk --debug --no-shrink --verbose
        timeout-minutes: 40

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
